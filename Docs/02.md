# NetworkKit 核心类型

## APIRequest

请求定义协议，通常用 `enum` 实现，每个 case 代表一个 API 端点。

```swift
public protocol APIRequest: Sendable {
    // 必须实现
    var path: String { get }
    var method: HTTPMethod { get }
    var task: RequestTask { get }
    
    // 可选（有默认值）
    var baseURL: URL? { get }                   // nil（使用 NetworkProvider 配置的默认值）
    var headers: [String: String]? { get }      // nil
    var timeout: TimeInterval { get }           // 60
    var validationType: ValidationType { get }  // .successCodes
    var mockResponse: MockResponse { get }      // .sample(Data())
}
```

### 完整示例

```swift
enum BookAPI: APIRequest {
    case list(page: Int, pageSize: Int)
    case detail(id: String)
    case create(book: CreateBookRequest)
    case update(id: String, book: UpdateBookRequest)
    case delete(id: String)
    
    // baseURL 可选：不实现则使用 NetworkProvider 配置的默认值
    // 如需覆盖，实现此属性：
    // var baseURL: URL? { URL(string: "https://other-api.com") }
    
    var path: String {
        switch self {
        case .list: return "/books"
        case .detail(let id): return "/books/\(id)"
        case .create: return "/books"
        case .update(let id, _): return "/books/\(id)"
        case .delete(let id): return "/books/\(id)"
        }
    }
    
    var method: HTTPMethod {
        switch self {
        case .list, .detail: return .get
        case .create: return .post
        case .update: return .put
        case .delete: return .delete
        }
    }
    
    var task: RequestTask {
        switch self {
        case .list(let page, let pageSize):
            return .parameters(
                ["page": page, "pageSize": pageSize],
                encoding: .urlQuery
            )
        case .detail, .delete:
            return .plain
        case .create(let book):
            return .encodable(book)
        case .update(_, let book):
            return .encodable(book)
        }
    }
    
    var headers: [String: String]? {
        ["X-API-Version": "2.0"]
    }
}
```

---

## RequestTask

定义请求的 Body 类型和编码方式。

```swift
public enum RequestTask {
    // 标准请求
    case plain                                              // 无 Body
    case data(Data)                                         // 原始数据
    case parameters([String: Any], encoding: ParameterEncoding)
    case encodable(any Encodable & Sendable, encoder: JSONEncoder = .init())
    
    // 复合请求（Body + URL Query）
    case compositeParameters(body: [String: Any], urlParameters: [String: Any])
    case compositeEncodable(body: any Encodable & Sendable, urlParameters: [String: Any], encoder: JSONEncoder = .init())
    
    // 上传
    case upload(UploadSource)
}

public enum ParameterEncoding {
    case json       // JSON Body
    case urlQuery   // URL Query String
    case urlForm    // URL-encoded Form Body
}
```

### 上传类型

```swift
public enum UploadSource {
    case data(Data)                     // 内存数据
    case file(URL)                      // 文件路径
    case multipart([MultipartFormPart]) // 多部分表单
}

public struct MultipartFormPart {
    public let name: String
    public let data: Data
    public let fileName: String?
    public let mimeType: String?
}
```

### 使用示例

```swift
// JSON Body
case .createUser(let params):
    return .parameters(params, encoding: .json)

// URL Query
case .search(let keyword):
    return .parameters(["q": keyword], encoding: .urlQuery)

// Encodable
case .updateProfile(let profile):
    return .encodable(profile)

// Body + URL Query
case .searchWithFilter(let body, let page):
    return .compositeParameters(
        body: body,
        urlParameters: ["page": page]
    )

// Multipart Upload
case .uploadImages(let images):
    let parts = images.enumerated().map { index, data in
        MultipartFormPart(
            name: "image\(index)",
            data: data,
            fileName: "image\(index).jpg",
            mimeType: "image/jpeg"
        )
    }
    return .upload(.multipart(parts))
```

---

## APIResponse

纯 HTTP 响应，不包含业务逻辑。数据解析由业务层处理。

```swift
public struct APIResponse: Sendable {
    public let statusCode: Int
    public let data: Data
    public let headers: [String: String]
    public let request: URLRequest?
    public let response: HTTPURLResponse?
}
```

### 解析数据

```swift
// 方式1：泛型方法（推荐）
let user: User = try await provider.request(UserAPI.getUser(id: "123"))

// 方式2：手动解码原始响应
let response = try await provider.request(UserAPI.getUser(id: "123"))
let user = try JSONDecoder().decode(User.self, from: response.data)

// 方式3：封装 Service
class UserService {
    private let provider: NetworkProviding
    
    func getUser(id: String) async throws -> User {
        try await provider.request(UserAPI.getUser(id: id))
    }
}
```

### NetworkProviding 协议

```swift
public protocol NetworkProviding {    
    /// 返回原始响应
    func request(_ target: APIRequest) async throws -> APIResponse
    
    /// 返回解码后的对象
    func request<T: Decodable>(_ target: APIRequest) async throws -> T
}
```

---

## NetworkError

网络层错误，只包含传输相关错误。业务错误由应用层处理。

```swift
public enum NetworkError: Error {
    /// 底层网络错误（来自 Alamofire/URLSession）
    case underlying(Error, APIResponse?)
    
    /// 无法构建 URLRequest（无效 URL 等）
    case requestMapping(String)
    
    /// 参数编码失败
    case parameterEncoding(Error)
    
    /// 响应解码失败
    case decoding(Error, Data)
}
```

### 便捷属性

```swift
let error: NetworkError = ...

// 获取关联的响应
if let response = error.response {
    print("Status: \(response.statusCode)")
}

// 获取底层错误
if let underlyingError = error.underlyingError {
    print("Underlying: \(underlyingError)")
}

// 获取响应数据（用于调试解码错误）
if let data = error.responseData {
    print("Raw response: \(String(data: data, encoding: .utf8) ?? "")")
}
```

---

## HTTPMethod

标准 HTTP 方法。

```swift
public enum HTTPMethod: String, Sendable {
    case get     = "GET"
    case post    = "POST"
    case put     = "PUT"
    case delete  = "DELETE"
    case patch   = "PATCH"
    case head    = "HEAD"
    case options = "OPTIONS"
}
```

---

## ValidationType

响应状态码验证。

```swift
public enum ValidationType: Sendable {
    /// 不验证
    case none
    
    /// 2xx 状态码（默认）
    case successCodes
    
    /// 2xx + 3xx 状态码
    case successAndRedirectCodes
    
    /// 自定义状态码范围
    case customCodes([Int])
}
```

### 示例

```swift
enum PaymentAPI: APIRequest {
    case process(orderId: String)
    
    var validationType: ValidationType {
        // 支付接口可能返回 202 Accepted
        .customCodes([200, 201, 202])
    }
}
```

---

## RequestContext

请求上下文，贯穿整个请求生命周期，用于插件间传递信息。

```swift
public actor RequestContext {
    // 不可变
    public let requestId: UUID
    public let target: any APIRequest
    public let startTime: Date
    
    // 可变状态
    public private(set) var urlRequest: URLRequest?
    public private(set) var response: APIResponse?
    public private(set) var error: Error?
    public private(set) var retryCount: Int
    
    // 元数据存储
    public func setMetadata<T>(_ value: T, forKey key: String)
    public func getMetadata<T>(forKey key: String) -> T?
    
    // 快照（用于同步回调）
    public func snapshot() -> Snapshot
}
```

### 插件间通信

```swift
// 在 TransformPlugin 中存储
class AuthPlugin: TransformPlugin {
    func adapt(_ request: URLRequest, context: RequestContext) async throws -> URLRequest {
        await context.setMetadata(Date(), forKey: "authTime")
        return request
    }
}

// 在 ObserverPlugin 中读取
class LogPlugin: ObserverPlugin {
    func didReceive(context: RequestContext) async {
        if let authTime: Date = await context.getMetadata(forKey: "authTime") {
            print("Auth was added at: \(authTime)")
        }
    }
}
```
